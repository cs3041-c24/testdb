<!DOCTYPE html>

<html>
<head>
    <link rel="stylesheet" type="text/css" href="https://x3dom.org/release/x3dom.css" media="screen and (orientation:portrait)"/>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://x3dom.org/release/x3dom-full.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-x3d@2.1.5/dist/d3-x3d.min.js"></script>
    <meta name="viewport" content="width=device-width, user-scalable=no"/>
    <title> COLOR ASSN </title>
</head>

<body>
    <!-- HTML5 article tag for content -->
    <div id="content">
   
    <header>COLOR ASSOCIATION TEST - RESULTS</header>

   <h1>Color Association Test - Results</h1>
    </div>

    <div id="scatter"></div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        // Documentation: https://firebase.google.com/docs/web/setup#available-libraries
      
        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyD9iR4okBA8TRKZZtOGd_F57CF54kQpExQ",
          authDomain: "colorassn.firebaseapp.com",
          databaseURL: "https://colorassn-default-rtdb.firebaseio.com/",
          projectId: "colorassn",
          storageBucket: "colorassn.appspot.com",
          messagingSenderId: "820973011771",
          appId: "1:820973011771:web:80d213bbd5a510cc2d2d1e"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Initialize Realtime Database and get a reference to the service
        const database = getDatabase(app);

        const dbRef = ref(getDatabase());
        get(child(dbRef, `/`)).then((snapshot) => {
            if (snapshot.exists()) {
                console.log(snapshot.val().users);
                window.userData = snapshot.val().users;
                helper(window.userData);
            } else {
                console.log("No data available");
            }
        }).catch((error) => {
            console.error(error);
        });
    </script>

    <script>
        // MOST OF THIS CODE IS MINE. THIS IS JUST A TEST.
        function helper(input) {
            function load(data) {
                // Select scatter
                var scatter = d3.select("#scatter");

                // Declare the chart component
                var plot = d3.x3d.chart.particlePlot()
                    .mappings({ x: "astar", y: "Lstar", z: "bstar", color: "cmy" })
                    .colors(colors);

                // Generate chart
                scatter.datum(data).call(plot);
            }

            var C = [];
            var M = [];
            var Y = [];

            var Lstar = [];
            var astar = [];
            var bstar = [];

            var indices = [];

            var j = 0;

            var colorAssn = {
                    key: 'ColorAssn',
                    values: []
            };

            var colors = [];

            for (uid in input) {
                for (i in input[uid]['test']['answers']) {
                    C[j] = input[uid]['test']['answers'][i]['beauty'];
                    M[j] = input[uid]['test']['answers'][i]['health'];
                    Y[j] = input[uid]['test']['answers'][i]['temperature'];

                    Lstar[j] = input[uid]['test']['colors'][i]['Lstar'];
                    astar[j] = input[uid]['test']['colors'][i]['astar'];
                    bstar[j] = input[uid]['test']['colors'][i]['bstar'];

                    indices[j] = j;

                    colorAssn.values.push({
                    key: 'Point' + indices[j],
                    values: [
                        { key: "Lstar", value: Lstar[j] },
                        { key: "astar", value: astar[j] },
                        { key: "bstar", value: bstar[j] },
                        { key: "cmy", value: d3.rgb(255-C[j],255-M[j],255-Y[j]) }
                    ]
                    })
                    colors.push(d3.rgb(0,0,0));

                    j++;
                }
            }

            window.colorAssn = colorAssn;

            load(colorAssn);
            x3dom.reload();
        }
    </script>
</body>
</html>